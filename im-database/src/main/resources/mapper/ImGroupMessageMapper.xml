<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xy.database.mapper.ImGroupMessageMapper">


    <resultMap id="ImGroupMessageResultMap" type="com.xy.domain.po.ImGroupMessagePo">
        <!-- 主键 -->
        <id column="message_id" property="messageId"/>

        <!-- 基本字段（列名 -> 属性名）-->
        <result column="group_id" property="groupId"/>
        <result column="from_id" property="fromId"/>
        <!-- message_body 使用 JacksonTypeHandler 反序列化为 Object -->
        <result column="message_body" property="messageBody"
                javaType="java.lang.Object"
                typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result column="message_time" property="messageTime" javaType="java.lang.Long"/>
        <result column="message_content_type" property="messageContentType" javaType="java.lang.Integer"/>
        <result column="extra" property="extra"/>
        <result column="reply_to" property="replyTo"/>
        <result column="sequence" property="sequence" javaType="java.lang.Long"/>
        <result column="message_random" property="messageRandom"/>
        <result column="create_time" property="createTime" javaType="java.lang.Long"/>
        <result column="update_time" property="updateTime" javaType="java.lang.Long"/>
        <result column="del_flag" property="delFlag" javaType="java.lang.Integer"/>
        <result column="version" property="version" javaType="java.lang.Integer"/>

        <!-- 来自关联表的字段，映射到实体中 exist=false 的属性 readStatus -->
        <result column="read_status" property="readStatus" javaType="java.lang.Integer"/>
    </resultMap>


    <select id="selectGroupMessageByGroupId" resultType="com.xy.domain.po.ImGroupMessagePo">
        select *
        from im_group_message igm
                 INNER JOIN im_group_message_status igms
                            on igm.message_id = igms.message_id and igm.group_id = igms.group_id
        where igms.group_id = #{groupId}
          and igms.to_id = #{userId}
          and igm.message_time > #{sequence}
        order by igm.message_time
    </select>

    <select id="selectLastGroupMessage" resultType="com.xy.domain.po.ImGroupMessagePo">
        select *
        from im_group_message igm
                 INNER JOIN im_group_message_status igms
                            on igm.message_id = igms.message_id and igm.group_id = igms.group_id
        where igms.group_id = #{groupId}
          and igms.to_id = #{userId}
        order by igm.message_time desc limit 1
    </select>

    <select id="selectGroupMessage" resultType="com.xy.domain.po.ImGroupMessagePo">
        SELECT *
        FROM im_group_message igm
                 INNER JOIN im_group_message_status igms ON igm.message_id = igms.message_id
            AND igm.group_id = igms.group_id
        WHERE igms.to_id = #{userId}

          AND igm.message_time > #{sequence}
        ORDER BY igm.message_time
    </select>

    <select id="selectReadStatus" resultType="java.lang.Integer">
        SELECT count(1)
        from im_group_message_status
        where group_id = #{groupId}
          and to_id = #{toId}
          and read_status = #{status}
    </select>

</mapper>
